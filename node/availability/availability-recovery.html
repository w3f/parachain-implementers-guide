<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Availability Recovery - The Polkadot Parachain Host Implementers' Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Preamble</a></li><li class="chapter-item expanded "><a href="../../whence-parachains.html"><strong aria-hidden="true">1.</strong> Whence Parachains</a></li><li class="chapter-item expanded "><a href="../../protocol-overview.html"><strong aria-hidden="true">2.</strong> Protocol Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol-approval.html"><strong aria-hidden="true">2.1.</strong> Approval Process</a></li></ol></li><li class="chapter-item expanded "><a href="../../architecture.html"><strong aria-hidden="true">3.</strong> Architecture Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../messaging.html"><strong aria-hidden="true">3.1.</strong> Messaging Overview</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime/index.html"><strong aria-hidden="true">4.</strong> Runtime Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime/initializer.html"><strong aria-hidden="true">4.1.</strong> Initializer Module</a></li><li class="chapter-item expanded "><a href="../../runtime/configuration.html"><strong aria-hidden="true">4.2.</strong> Configuration Module</a></li><li class="chapter-item expanded "><a href="../../runtime/disputes.html"><strong aria-hidden="true">4.3.</strong> Disputes Module</a></li><li class="chapter-item expanded "><a href="../../runtime/paras.html"><strong aria-hidden="true">4.4.</strong> Paras Module</a></li><li class="chapter-item expanded "><a href="../../runtime/scheduler.html"><strong aria-hidden="true">4.5.</strong> Scheduler Module</a></li><li class="chapter-item expanded "><a href="../../runtime/inclusion.html"><strong aria-hidden="true">4.6.</strong> Inclusion Module</a></li><li class="chapter-item expanded "><a href="../../runtime/inclusioninherent.html"><strong aria-hidden="true">4.7.</strong> InclusionInherent Module</a></li><li class="chapter-item expanded "><a href="../../runtime/dmp.html"><strong aria-hidden="true">4.8.</strong> DMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/ump.html"><strong aria-hidden="true">4.9.</strong> UMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/hrmp.html"><strong aria-hidden="true">4.10.</strong> HRMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/session_info.html"><strong aria-hidden="true">4.11.</strong> Session Info Module</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime-api/index.html"><strong aria-hidden="true">5.</strong> Runtime APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime-api/validators.html"><strong aria-hidden="true">5.1.</strong> Validators</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validator-groups.html"><strong aria-hidden="true">5.2.</strong> Validator Groups</a></li><li class="chapter-item expanded "><a href="../../runtime-api/availability-cores.html"><strong aria-hidden="true">5.3.</strong> Availability Cores</a></li><li class="chapter-item expanded "><a href="../../runtime-api/persisted-validation-data.html"><strong aria-hidden="true">5.4.</strong> Persisted Validation Data</a></li><li class="chapter-item expanded "><a href="../../runtime-api/session-index.html"><strong aria-hidden="true">5.5.</strong> Session Index</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validation-code.html"><strong aria-hidden="true">5.6.</strong> Validation Code</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-pending-availability.html"><strong aria-hidden="true">5.7.</strong> Candidate Pending Availability</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-events.html"><strong aria-hidden="true">5.8.</strong> Candidate Events</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/index.html"><strong aria-hidden="true">6.</strong> Node Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/subsystems-and-jobs.html"><strong aria-hidden="true">6.1.</strong> Subsystems and Jobs</a></li><li class="chapter-item expanded "><a href="../../node/overseer.html"><strong aria-hidden="true">6.2.</strong> Overseer</a></li><li class="chapter-item expanded "><a href="../../node/grandpa-voting-rule.html"><strong aria-hidden="true">6.3.</strong> GRANDPA Voting Rule</a></li><li class="chapter-item expanded "><a href="../../node/collators/index.html"><strong aria-hidden="true">6.4.</strong> Collator Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/collators/collation-generation.html"><strong aria-hidden="true">6.4.1.</strong> Collation Generation</a></li><li class="chapter-item expanded "><a href="../../node/collators/collator-protocol.html"><strong aria-hidden="true">6.4.2.</strong> Collator Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/backing/index.html"><strong aria-hidden="true">6.5.</strong> Backing Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/backing/candidate-selection.html"><strong aria-hidden="true">6.5.1.</strong> Candidate Selection</a></li><li class="chapter-item expanded "><a href="../../node/backing/candidate-backing.html"><strong aria-hidden="true">6.5.2.</strong> Candidate Backing</a></li><li class="chapter-item expanded "><a href="../../node/backing/statement-distribution.html"><strong aria-hidden="true">6.5.3.</strong> Statement Distribution</a></li><li class="chapter-item expanded "><a href="../../node/backing/pov-distribution.html"><strong aria-hidden="true">6.5.4.</strong> PoV Distribution</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/availability/index.html"><strong aria-hidden="true">6.6.</strong> Availability Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/availability/availability-distribution.html"><strong aria-hidden="true">6.6.1.</strong> Availability Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/availability-recovery.html" class="active"><strong aria-hidden="true">6.6.2.</strong> Availability Recovery</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-distribution.html"><strong aria-hidden="true">6.6.3.</strong> Bitfield Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-signing.html"><strong aria-hidden="true">6.6.4.</strong> Bitfield Signing</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/approval/index.html"><strong aria-hidden="true">6.7.</strong> Approval Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/approval/approval-voting.html"><strong aria-hidden="true">6.7.1.</strong> Approval Voting</a></li><li class="chapter-item expanded "><a href="../../node/approval/approval-distribution.html"><strong aria-hidden="true">6.7.2.</strong> Approval Distribution</a></li><li class="chapter-item expanded "><a href="../../node/approval/dispute-participation.html"><strong aria-hidden="true">6.7.3.</strong> Dispute Participation</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/utility/index.html"><strong aria-hidden="true">6.8.</strong> Utility Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/utility/availability-store.html"><strong aria-hidden="true">6.8.1.</strong> Availability Store</a></li><li class="chapter-item expanded "><a href="../../node/utility/candidate-validation.html"><strong aria-hidden="true">6.8.2.</strong> Candidate Validation</a></li><li class="chapter-item expanded "><a href="../../node/utility/provisioner.html"><strong aria-hidden="true">6.8.3.</strong> Provisioner</a></li><li class="chapter-item expanded "><a href="../../node/utility/network-bridge.html"><strong aria-hidden="true">6.8.4.</strong> Network Bridge</a></li><li class="chapter-item expanded "><a href="../../node/utility/misbehavior-arbitration.html"><strong aria-hidden="true">6.8.5.</strong> Misbehavior Arbitration</a></li><li class="chapter-item expanded "><a href="../../node/utility/peer-set-manager.html"><strong aria-hidden="true">6.8.6.</strong> Peer Set Manager</a></li><li class="chapter-item expanded "><a href="../../node/utility/runtime-api.html"><strong aria-hidden="true">6.8.7.</strong> Runtime API Requests</a></li><li class="chapter-item expanded "><a href="../../node/utility/chain-api.html"><strong aria-hidden="true">6.8.8.</strong> Chain API Requests</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../types/index.html"><strong aria-hidden="true">7.</strong> Data Structures and Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../types/candidate.html"><strong aria-hidden="true">7.1.</strong> Candidate</a></li><li class="chapter-item expanded "><a href="../../types/backing.html"><strong aria-hidden="true">7.2.</strong> Backing</a></li><li class="chapter-item expanded "><a href="../../types/availability.html"><strong aria-hidden="true">7.3.</strong> Availability</a></li><li class="chapter-item expanded "><a href="../../types/overseer-protocol.html"><strong aria-hidden="true">7.4.</strong> Overseer and Subsystem Protocol</a></li><li class="chapter-item expanded "><a href="../../types/runtime.html"><strong aria-hidden="true">7.5.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../../types/chain.html"><strong aria-hidden="true">7.6.</strong> Chain</a></li><li class="chapter-item expanded "><a href="../../types/messages.html"><strong aria-hidden="true">7.7.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../../types/network.html"><strong aria-hidden="true">7.8.</strong> Network</a></li><li class="chapter-item expanded "><a href="../../types/approval.html"><strong aria-hidden="true">7.9.</strong> Approvals</a></li></ol></li><li class="chapter-item expanded "><a href="../../glossary.html">Glossary</a></li><li class="chapter-item expanded affix "><a href="../../further-reading.html">Further Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Polkadot Parachain Host Implementers' Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#availability-recovery" id="availability-recovery">Availability Recovery</a></h1>
<blockquote>
<p>TODO: <a href="https://github.com/paritytech/polkadot/issues/1597">https://github.com/paritytech/polkadot/issues/1597</a></p>
</blockquote>
<p>This subsystem is the inverse of the <a href="availability-distribution.html">Availability Distribution</a> subsystem: validators will serve the availability chunks kept in the availability store to nodes who connect to them. And the subsystem will also implement the other side: the logic for nodes to connect to validators, request availability pieces, and reconstruct the <code>AvailableData</code>.</p>
<p>This version of the availability recovery subsystem is based off of direct connections to validators. In order to recover any given <code>AvailableData</code>, we must recover at least <code>f + 1</code> pieces from validators of the session. Thus, we will connect to and query randomly chosen validators until we have received <code>f + 1</code> pieces.</p>
<h2><a class="header" href="#protocol" id="protocol">Protocol</a></h2>
<p><code>PeerSet</code>: <code>Validation</code></p>
<p>Input:</p>
<ul>
<li>NetworkBridgeUpdateV1(update)</li>
<li>AvailabilityRecoveryMessage::RecoverAvailableData(candidate, session, response)</li>
</ul>
<p>Output:</p>
<ul>
<li>NetworkBridge::SendValidationMessage</li>
<li>NetworkBridge::ReportPeer</li>
<li>AvailabilityStore::QueryChunk</li>
</ul>
<h2><a class="header" href="#functionality" id="functionality">Functionality</a></h2>
<p>We hold a state which tracks the current recovery interactions we have live, as well as which request IDs correspond to which interactions. An interaction is a structure encapsulating all interaction with the network necessary to recover the available data.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>type ChunkResponse = Result&lt;(PeerId, ErasureChunk), Unavailable&gt;;

struct AwaitedChunk {
    issued_at: Instant,
    validator_index: ValidatorIndex,
    candidate_hash: CandidateHash,
    response: ResponseChannel&lt;ChunkResponse&gt;,
}

struct State {
    /// Each interaction is implemented as its own async task, and these handles are for communicating with them.
    interactions: Map&lt;CandidateHash, InteractionHandle&gt;,
    /// A recent block hash for which state should be available.
    live_block_hash: Hash,
    discovering_validators: Map&lt;AuthorityDiscoveryId, Vec&lt;AwaitedChunk&gt;&gt;,
    live_chunk_requests: Map&lt;RequestId, (PeerId, AwaitedChunk)&gt;,
    next_request_id: RequestId,
    connecting_validators: Stream&lt;(AuthorityDiscoveryId, PeerId)&gt;,

    /// interaction communication. This is cloned and given to interactions that are spun up.
    from_interaction_tx: Sender&lt;FromInteraction&gt;,
    /// receiver for messages from interactions.
    from_interaction_rx: Receiver&lt;FromInteraction&gt;,

    // An LRU cache of recently recovered data.
    availability_lru: LruCache&lt;CandidateHash, Result&lt;AvailableData, RecoveryError&gt;&gt;,
}

struct InteractionHandle {
    awaiting: Vec&lt;ResponseChannel&lt;Result&lt;AvailableData, RecoveryError&gt;&gt;&gt;,
}

struct Unavailable;
enum FromInteraction {
    // An interaction concluded.
    Concluded(CandidateHash, Result&lt;AvailableData, RecoveryError&gt;),
    // Make a request of a particular chunk from a particular validator.
    MakeRequest(
        AuthorityDiscoveryId, 
        CandidateHash, 
        ValidatorIndex, 
        ResponseChannel&lt;ChunkResponse&gt;,
    ),
    // Report a peer.
    ReportPeer(
        PeerId,
        Rep,
    ),
}

struct Interaction {
    to_state: Sender&lt;FromInteraction&gt;,
    validator_authority_keys: Vec&lt;AuthorityId&gt;,
    validators: Vec&lt;ValidatorId&gt;,
    // a random shuffling of the validators which indicates the order in which we connect to the validators and
    // request the chunk from them.
    shuffling: Vec&lt;ValidatorIndex&gt;, 
    // The number of pieces needed.
    threshold: usize, 
    candidate_hash: Hash,
    erasure_root: Hash,
    received_chunks: Map&lt;ValidatorIndex, ErasureChunk&gt;,
    requesting_chunks: FuturesUnordered&lt;Receiver&lt;ChunkResponse&gt;&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#signal-handling" id="signal-handling">Signal Handling</a></h3>
<p>On <code>ActiveLeavesUpdate</code>, if <code>activated</code> is non-empty, set <code>state.live_block_hash</code> to the first block in <code>Activated</code>.</p>
<p>Ignore <code>BlockFinalized</code> signals.</p>
<p>On <code>Conclude</code>, shut down the subsystem.</p>
<h4><a class="header" href="#availabilityrecoverymessagerecoveravailabledatareceipt-session-response" id="availabilityrecoverymessagerecoveravailabledatareceipt-session-response"><code>AvailabilityRecoveryMessage::RecoverAvailableData(receipt, session, response)</code></a></h4>
<ol>
<li>Check the <code>availability_lru</code> for the candidate and return the data if so.</li>
<li>Check if there is already an interaction handle for the request. If so, add the response handle to it.</li>
<li>Otherwise, load the session info for the given session under the state of <code>live_block_hash</code>, and initiate an interaction with <em>launch_interaction</em>. Add an interaction handle to the state and add the response channel to it.</li>
<li>If the session info is not available, return <code>RecoveryError::Unavailable</code> on the response channel.</li>
</ol>
<h3><a class="header" href="#from-interaction-logic" id="from-interaction-logic">From-interaction logic</a></h3>
<h4><a class="header" href="#frominteractionconcluded" id="frominteractionconcluded"><code>FromInteraction::Concluded</code></a></h4>
<ol>
<li>Load the entry from the <code>interactions</code> map. It should always exist, if not for logic errors. Send the result to each member of <code>awaiting</code>.</li>
<li>Add the entry to the availability_lru.</li>
</ol>
<h4><a class="header" href="#frominteractionmakerequestdiscovery_pub-candidate_hash-validator_index-response" id="frominteractionmakerequestdiscovery_pub-candidate_hash-validator_index-response"><code>FromInteraction::MakeRequest(discovery_pub, candidate_hash, validator_index, response)</code></a></h4>
<ol>
<li>Add an <code>AwaitedRequest</code> to the <code>discovering_validators</code> map under <code>discovery_pub</code>.</li>
<li>Issue a <code>NetworkBridgeMessage::ConnectToValidators</code>.</li>
<li>Add the stream of connected validator events to <code>state.connecting_validators</code>.</li>
</ol>
<h4><a class="header" href="#frominteractionreportpeerpeer-rep" id="frominteractionreportpeerpeer-rep"><code>FromInteraction::ReportPeer(peer, rep)</code></a></h4>
<ol>
<li>Issue a <code>NetworkBridgeMessage::ReportPeer(peer, rep)</code>.</li>
</ol>
<h3><a class="header" href="#responding-to-network-events" id="responding-to-network-events">Responding to network events.</a></h3>
<h4><a class="header" href="#on-connecting_validators-event" id="on-connecting_validators-event">On <code>connecting_validators</code> event:</a></h4>
<ol>
<li>If the validator exists under <code>discovering_validators</code>, remove the entry.</li>
<li>For each <code>AwaitedChunk</code> in the entry, issue a <code>AvailabilityRecoveryV1Message::RequestChunk(next_request_id, candidate_hash, validator_index)</code> and make an entry in the <code>live_chunk_requests</code> map.</li>
</ol>
<h4><a class="header" href="#on-receiving-availabilityrecoveryv1requestchunkr_id-candidate_hash-validator_index" id="on-receiving-availabilityrecoveryv1requestchunkr_id-candidate_hash-validator_index">On receiving <code>AvailabilityRecoveryV1::RequestChunk(r_id, candidate_hash, validator_index)</code></a></h4>
<ol>
<li>Issue a <code>AvailabilityStore::QueryChunk(candidate-hash, validator_index, response)</code> message.</li>
<li>Whatever the result, issue a <code>AvailabilityRecoveryV1Message::Chunk(r_id, response)</code> message.</li>
</ol>
<h4><a class="header" href="#on-receiving-availabilityrecoveryv1chunkr_id-chunk" id="on-receiving-availabilityrecoveryv1chunkr_id-chunk">On receiving <code>AvailabilityRecoveryV1::Chunk(r_id, chunk)</code></a></h4>
<ol>
<li>If there exists an entry under <code>r_id</code>, remove it. If there doesn't exist one, report the peer and return. If the peer in the entry doesn't match the sending peer, reinstate the entry, report the peer, and return.</li>
<li>Send the chunk response on the <code>awaited_chunk</code> for the interaction to handle.</li>
</ol>
<h3><a class="header" href="#interaction-logic" id="interaction-logic">Interaction logic</a></h3>
<h4><a class="header" href="#launch_interactionsession_index-session_info-candidate_receipt-candidate_hash" id="launch_interactionsession_index-session_info-candidate_receipt-candidate_hash"><code>launch_interaction(session_index, session_info, candidate_receipt, candidate_hash)</code></a></h4>
<ol>
<li>Compute the threshold from the session info. It should be <code>f + 1</code>, where <code>n = 3f + k</code>, where <code>k in {1, 2, 3}</code>, and <code>n</code> is the number of validators.</li>
<li>Set the various fields of <code>Interaction</code> based on the validator lists in <code>session_info</code>. Compute a random shuffling of the validator indices.</li>
<li>Set the <code>to_state</code> sender to be equal to a clone of <code>state.from_interaction_tx</code>.</li>
<li>Initialize <code>received_chunks</code> to an empty set, as well as <code>requesting_chunks</code>.</li>
</ol>
<p>Launch the interaction as a background task running <code>interaction_loop(interaction)</code>.</p>
<h4><a class="header" href="#interaction_loopinteraction" id="interaction_loopinteraction"><code>interaction_loop(interaction)</code></a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// How many parallel requests to have going at once.
const N_PARALLEL: usize = 50;
<span class="boring">}
</span></code></pre></pre>
<p>Loop:</p>
<ul>
<li>Poll for new updates from <code>requesting_chunks</code>. Check merkle proofs of any received chunks, and any failures should lead to issuance of a <code>FromInteraction::ReportPeer</code> message.</li>
<li>If <code>received_chunks</code> has more than <code>threshold</code> entries, attempt to recover the data. If that fails, or a re-encoding of it doesn't match the expected erasure root, break and issue a <code>FromInteraction::Concluded(RecoveryError::Invalid)</code>. Otherwise, issue a <code>FromInteraction::Concluded(Ok(()))</code>.</li>
<li>While there are fewer than <code>N_PARALLEL</code> entries in <code>requesting_chunks</code>,
<ul>
<li>Pop the next item from <code>shuffling</code>. If it's empty and <code>requesting_chunks</code> is empty, break and issue a <code>FromInteraction::Concluded(RecoveryError::Unavailable)</code>.</li>
<li>Initialize <code>(tx, rx)</code>.</li>
<li>Issue a <code>FromInteraction::MakeRequest(validator, candidate_hash, validator_index, tx)</code>.</li>
<li>Add <code>rx</code> to <code>requesting_chunks</code>.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../node/availability/availability-distribution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../node/availability/bitfield-distribution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../node/availability/availability-distribution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../node/availability/bitfield-distribution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
